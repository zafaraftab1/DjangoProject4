{% extends "updateAPI/base.html" %}

{% block title %}Submissions | DjangoProject4{% endblock %}

{% block page_styles %}
<style>
    :root {
        --dash-bg-1: #f3f7ff;
        --dash-bg-2: #e6efff;
        --dash-panel: #ffffff;
        --dash-ink: #12223a;
        --dash-muted: #5f6f82;
        --dash-line: #d8e3ef;
        --dash-brand: #0f66cc;
        --dash-brand-deep: #094f9f;
        --dash-good: #0e8f5a;
        --dash-shadow: 0 14px 32px rgba(10, 40, 79, 0.1);
    }
    .dashboard {
        background:
            radial-gradient(circle at 6% 6%, #dceaff 0%, transparent 35%),
            radial-gradient(circle at 96% 4%, #d8f1ff 0%, transparent 33%),
            linear-gradient(170deg, var(--dash-bg-1), var(--dash-bg-2));
        min-height: calc(100vh - 140px);
        padding: 24px;
    }
    .container {
        max-width: 1160px;
        margin: 0 auto;
    }
    .hero {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 14px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    .eyebrow {
        display: inline-block;
        background: #e7f0ff;
        border: 1px solid #cddffa;
        color: #0b4f99;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.6px;
        text-transform: uppercase;
        border-radius: 999px;
        padding: 4px 9px;
    }
    .hero h1 {
        margin: 10px 0 0;
        font-size: 34px;
        letter-spacing: 0.2px;
        font-family: "Space Grotesk", sans-serif;
    }
    .hero p {
        margin: 7px 0 0;
        color: var(--dash-muted);
        max-width: 700px;
    }
    .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .btn {
        border: 0;
        border-radius: 11px;
        padding: 10px 14px;
        font-size: 13px;
        text-decoration: none;
        cursor: pointer;
        color: #fff;
        background: linear-gradient(130deg, var(--dash-brand), var(--dash-brand-deep));
        box-shadow: 0 10px 24px rgba(10, 76, 153, 0.25);
        font-weight: 700;
    }
    .btn.ghost {
        background: #fff;
        color: var(--dash-brand);
        border: 1px solid var(--dash-line);
        box-shadow: none;
    }
    .btn.soft {
        background: #f2f8ff;
        color: var(--dash-brand-deep);
        border: 1px solid #d6e6fb;
        box-shadow: none;
    }
    .stats {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 12px;
        margin-bottom: 16px;
    }
    .stat {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.96), rgba(255, 255, 255, 0.88));
        border: 1px solid var(--dash-line);
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 8px 20px rgba(17, 41, 73, 0.06);
    }
    .stat .label {
        color: var(--dash-muted);
        font-size: 12px;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.35px;
    }
    .stat .value {
        font-size: 26px;
        font-weight: 800;
        color: var(--dash-ink);
    }
    .stat .meta {
        margin-top: 5px;
        font-size: 12px;
        color: #4e6580;
    }
    .panel {
        background: var(--dash-panel);
        border: 1px solid var(--dash-line);
        border-radius: 16px;
        box-shadow: var(--dash-shadow);
        overflow: hidden;
    }
    .toolbar {
        padding: 14px;
        border-bottom: 1px solid var(--dash-line);
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        align-items: center;
        background: linear-gradient(180deg, #f9fbff, #f4f8ff);
    }
    .search {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .search input {
        min-width: 290px;
        max-width: 100%;
        border: 1px solid var(--dash-line);
        border-radius: 10px;
        padding: 11px 12px;
        font-size: 14px;
        transition: box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .search input:focus {
        outline: none;
        border-color: var(--dash-brand);
        box-shadow: 0 0 0 3px rgba(13, 103, 211, 0.12);
    }
    .search button {
        border: 0;
        border-radius: 10px;
        background: var(--dash-good);
        color: #fff;
        padding: 11px 15px;
        cursor: pointer;
        font-weight: 700;
    }
    .controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
    }
    .controls select {
        border: 1px solid var(--dash-line);
        border-radius: 10px;
        padding: 9px 10px;
        background: #fff;
        color: var(--dash-ink);
        font-family: inherit;
    }
    .control-tools {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        padding: 12px 14px;
        border-bottom: 1px solid var(--dash-line);
        background: #fff;
        align-items: center;
    }
    .tool-label {
        font-size: 12px;
        color: var(--dash-muted);
        text-transform: uppercase;
        letter-spacing: 0.35px;
        margin-right: 2px;
        font-weight: 700;
    }
    .chip {
        border: 1px solid #d6e5f9;
        background: #f1f7ff;
        color: #0f58af;
        border-radius: 999px;
        padding: 6px 11px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
    }
    .chip.active {
        background: linear-gradient(120deg, var(--dash-brand), var(--dash-brand-deep));
        border-color: transparent;
        color: #fff;
    }
    .subtle {
        font-size: 12px;
        color: var(--dash-muted);
    }
    .table-wrap {
        overflow-x: auto;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 980px;
    }
    th, td {
        padding: 12px 14px;
        border-bottom: 1px solid var(--dash-line);
        text-align: left;
        vertical-align: top;
        font-size: 14px;
    }
    th {
        background: #f4f8ff;
        color: #204365;
        position: sticky;
        top: 0;
        z-index: 1;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        font-size: 11px;
    }
    tbody tr.submission-row:hover td {
        background: #f8fbff;
    }
    .contact-name {
        font-weight: 700;
        color: #0f2e4c;
    }
    .contact-mail {
        margin-top: 3px;
    }
    .id-pill {
        display: inline-block;
        background: #e9f3ff;
        color: #0c4d94;
        border: 1px solid #c7dcf6;
        font-weight: 700;
        border-radius: 999px;
        padding: 3px 9px;
        font-size: 12px;
    }
    .email-link {
        color: #0a62cc;
        text-decoration: none;
    }
    .email-link:hover {
        text-decoration: underline;
    }
    .website-link {
        display: inline-block;
        color: #0a62cc;
        background: #f0f7ff;
        border: 1px solid #d5e6fb;
        border-radius: 8px;
        padding: 4px 8px;
        text-decoration: none;
        font-size: 12px;
        font-weight: 700;
    }
    .muted-dash {
        color: #8a9aaf;
    }
    .action-row {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: wrap;
    }
    .mini-btn {
        border: 1px solid #d1e2f7;
        background: #f0f7ff;
        color: #0a62cc;
        border-radius: 8px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 700;
    }
    .msg-preview {
        max-width: 340px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .detail-row {
        display: none;
    }
    .detail-row.open {
        display: table-row;
    }
    .detail-box {
        background: #f8fbff;
        border: 1px solid #dde8f7;
        border-radius: 12px;
        padding: 12px;
    }
    .detail-title {
        font-size: 12px;
        font-weight: 700;
        color: #385878;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .detail-message {
        margin: 0;
        color: #17314f;
        line-height: 1.5;
        white-space: pre-wrap;
    }
    .pager {
        padding: 14px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        border-top: 1px solid var(--dash-line);
        background: linear-gradient(180deg, #ffffff, #f8fbff);
    }
    .pager a {
        color: var(--dash-brand);
        text-decoration: none;
        font-weight: 700;
        background: #f0f7ff;
        border: 1px solid #d1e2f7;
        padding: 6px 10px;
        border-radius: 8px;
    }
    .empty {
        padding: 28px 14px;
        color: var(--dash-muted);
    }
    .dense th,
    .dense td {
        padding-top: 8px;
        padding-bottom: 8px;
    }
    @media (max-width: 980px) {
        .stats {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .dashboard {
            padding: 14px;
        }
        .hero h1 {
            font-size: 27px;
        }
        .toolbar {
            grid-template-columns: 1fr;
        }
    }
    @media (max-width: 620px) {
        .stats {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="container">
        <div class="hero">
            <div>
                <span class="eyebrow">Lead Management</span>
                <h1>Submissions Dashboard</h1>
                <p>Review incoming leads, filter by quality signals, expand full messages, and export records when needed.</p>
            </div>
            <div class="actions">
                <a class="btn ghost" href="{% url 'home' %}">Back to Form</a>
                <a class="btn js-export" href="{% url 'submissions_export_csv' %}">Export CSV</a>
            </div>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="label">Total Records</div>
                <div class="value">{{ total_count }}</div>
                <div class="meta">All submissions in database</div>
            </div>
            <div class="stat">
                <div class="label">Filtered Results</div>
                <div class="value">{{ filtered_count }}</div>
                <div class="meta">Current search result size</div>
            </div>
            <div class="stat">
                <div class="label">Page</div>
                <div class="value">{{ page_obj.number }}</div>
                <div class="meta">of {{ page_obj.paginator.num_pages }} pages</div>
            </div>
            <div class="stat">
                <div class="label">Visible Rows</div>
                <div class="value" id="localVisibleCount">{{ page_obj.object_list|length }}</div>
                <div class="meta">after quick filters on this page</div>
            </div>
        </div>

        <div class="panel">
            <div class="toolbar">
                <form class="search" method="get">
                    <input id="submissionSearchInput" type="text" name="q" placeholder="Search name, email, phone or message" value="{{ query }}">
                    <input type="hidden" name="sort" value="{{ sort }}">
                    <input type="hidden" name="order" value="{{ order }}">
                    <input type="hidden" name="per_page" value="{{ per_page }}">
                    <button type="submit">Search</button>
                </form>
                <form class="controls" method="get">
                    <input type="hidden" name="q" value="{{ query }}">
                    <select name="sort" onchange="this.form.submit()">
                        <option value="id" {% if sort == 'id' %}selected{% endif %}>Sort: ID</option>
                        <option value="name" {% if sort == 'name' %}selected{% endif %}>Sort: Name</option>
                        <option value="email" {% if sort == 'email' %}selected{% endif %}>Sort: Email</option>
                    </select>
                    <select name="order" onchange="this.form.submit()">
                        <option value="desc" {% if order == 'desc' %}selected{% endif %}>Order: Desc</option>
                        <option value="asc" {% if order == 'asc' %}selected{% endif %}>Order: Asc</option>
                    </select>
                    <select name="per_page" onchange="this.form.submit()">
                        <option value="10" {% if per_page == 10 %}selected{% endif %}>10 / page</option>
                        <option value="25" {% if per_page == 25 %}selected{% endif %}>25 / page</option>
                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50 / page</option>
                    </select>
                    {% if query %}
                        <a class="btn ghost" href="{% url 'submissions' %}?sort={{ sort }}&order={{ order }}&per_page={{ per_page }}">Clear Filter</a>
                    {% endif %}
                </form>
            </div>

            <div class="control-tools">
                <span class="tool-label">Quick View</span>
                <button type="button" class="chip js-local-filter active" data-mode="all">All</button>
                <button type="button" class="chip js-local-filter" data-mode="website">Has Website</button>
                <button type="button" class="chip js-local-filter" data-mode="long">Long Message</button>
                <button type="button" class="chip js-toggle-density" data-mode="regular">Dense Mode</button>
                <span class="subtle">Tip: press <strong>/</strong> to focus search</span>
            </div>

            <div class="table-wrap" id="submissionsTableWrap">
                <table>
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Contact</th>
                        <th>Phone</th>
                        <th>Website</th>
                        <th>Message</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for row in page_obj %}
                        <tr class="submission-row" data-row-id="{{ row.id }}" data-has-website="{% if row.website %}1{% else %}0{% endif %}" data-msg-len="{{ row.message|default:''|length }}">
                            <td><span class="id-pill">#{{ row.id }}</span></td>
                            <td>
                                <div class="contact-name">{{ row.name }}</div>
                                <div class="contact-mail">
                                    <a class="email-link" href="mailto:{{ row.email }}">{{ row.email }}</a>
                                </div>
                            </td>
                            <td>{{ row.phone|default:'-' }}</td>
                            <td>
                                {% if row.website %}
                                    <a class="website-link" href="{{ row.website }}" target="_blank" rel="noopener noreferrer">Visit</a>
                                {% else %}
                                    <span class="muted-dash">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="msg-preview">{{ row.message }}</div>
                            </td>
                            <td>
                                <div class="action-row">
                                    <button type="button" class="mini-btn js-toggle-detail" data-target="detail-{{ row.id }}">View</button>
                                    <button type="button" class="mini-btn js-copy" data-copy="{{ row.email }}">Copy Email</button>
                                    <button type="button" class="mini-btn js-copy" data-copy="{{ row.message }}">Copy Msg</button>
                                </div>
                            </td>
                        </tr>
                        <tr id="detail-{{ row.id }}" class="detail-row">
                            <td colspan="6">
                                <div class="detail-box">
                                    <div class="detail-title">Full Message</div>
                                    <p class="detail-message">{{ row.message }}</p>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td class="empty" colspan="6">No submissions found for this search.</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="pager">
                {% if page_obj.has_previous %}
                    <a href="?q={{ query }}&sort={{ sort }}&order={{ order }}&per_page={{ per_page }}&page=1">First</a>
                    <a href="?q={{ query }}&sort={{ sort }}&order={{ order }}&per_page={{ per_page }}&page={{ page_obj.previous_page_number }}">Previous</a>
                {% endif %}

                <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                <span class="subtle">Showing {{ page_obj.object_list|length }} of {{ filtered_count }} results</span>

                {% if page_obj.has_next %}
                    <a href="?q={{ query }}&sort={{ sort }}&order={{ order }}&per_page={{ per_page }}&page={{ page_obj.next_page_number }}">Next</a>
                    <a href="?q={{ query }}&sort={{ sort }}&order={{ order }}&per_page={{ per_page }}&page={{ page_obj.paginator.num_pages }}">Last</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    (function () {
        const filterButtons = Array.from(document.querySelectorAll(".js-local-filter"));
        const rows = Array.from(document.querySelectorAll(".submission-row"));
        const visibleCountEl = document.getElementById("localVisibleCount");
        const tableWrap = document.getElementById("submissionsTableWrap");
        const densityToggle = document.querySelector(".js-toggle-density");

        function applyLocalFilter(mode) {
            let visible = 0;
            rows.forEach(function (row) {
                const hasWebsite = row.getAttribute("data-has-website") === "1";
                const msgLen = parseInt(row.getAttribute("data-msg-len") || "0", 10);
                let show = true;

                if (mode === "website") show = hasWebsite;
                if (mode === "long") show = msgLen >= 120;

                row.style.display = show ? "" : "none";

                const detailRow = document.getElementById("detail-" + row.getAttribute("data-row-id"));
                if (detailRow) {
                    detailRow.style.display = "none";
                    detailRow.classList.remove("open");
                    if (!show) {
                        detailRow.style.display = "none";
                    }
                }

                if (show) visible += 1;
            });

            if (visibleCountEl) {
                visibleCountEl.textContent = visible;
            }
        }

        filterButtons.forEach(function (button) {
            button.addEventListener("click", function () {
                filterButtons.forEach(function (chip) {
                    chip.classList.remove("active");
                });
                button.classList.add("active");
                applyLocalFilter(button.getAttribute("data-mode") || "all");
            });
        });

        document.querySelectorAll(".js-toggle-detail").forEach(function (button) {
            button.addEventListener("click", function () {
                const target = button.getAttribute("data-target");
                const detailRow = target ? document.getElementById(target) : null;
                if (!detailRow) return;

                const isOpen = detailRow.classList.contains("open");
                if (isOpen) {
                    detailRow.classList.remove("open");
                    detailRow.style.display = "none";
                    button.textContent = "View";
                } else {
                    detailRow.classList.add("open");
                    detailRow.style.display = "table-row";
                    button.textContent = "Hide";
                }
            });
        });

        if (densityToggle && tableWrap) {
            densityToggle.addEventListener("click", function () {
                const dense = tableWrap.classList.toggle("dense");
                densityToggle.textContent = dense ? "Regular Mode" : "Dense Mode";
            });
        }

        const searchInput = document.getElementById("submissionSearchInput");
        document.addEventListener("keydown", function (event) {
            if (event.key === "/" && searchInput && document.activeElement !== searchInput) {
                event.preventDefault();
                searchInput.focus();
            }
        });
    })();
</script>
{% endblock %}
